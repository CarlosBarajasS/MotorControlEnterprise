<!-- TOPBAR -->
<div class="topbar">
    <div>
        <h1>C√°maras IP</h1>
        <p class="subtitle">Administra feeds RTSP, NVR y SD en el sistema Edge</p>
    </div>
    <div style="display:flex;gap:12px;align-items:center;">
        <span class="badge active" style="font-size:13px;padding:7px 14px;">
            {{ camerasOnline() }}/{{ filtered().length }} en l√≠nea
        </span>
        <button class="btn-secondary" (click)="loadData()">üîÑ Actualizar</button>
        <button class="btn-primary" (click)="openCreate()">+ A√±adir C√°mara</button>
    </div>
</div>

<!-- FILTERS -->
<div class="cam-filters">
    <input class="cam-search" type="text" placeholder="üîç Buscar c√°mara o ubicaci√≥n..." [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)">
    <div class="filter-pills">
        <button class="filter-pill" [class.active]="filterStatus() === 'all'"
            (click)="filterStatus.set('all')">Todas</button>
        <button class="filter-pill" [class.active]="filterStatus() === 'online'" (click)="filterStatus.set('online')">
            <span class="pill-dot online"></span>Online
        </button>
        <button class="filter-pill" [class.active]="filterStatus() === 'offline'" (click)="filterStatus.set('offline')">
            <span class="pill-dot offline"></span>Offline
        </button>
    </div>
</div>

<!-- CAMERA GRID CARDS -->
<div class="cam-grid" *ngIf="filtered().length > 0">
    <div class="cam-card" *ngFor="let cam of filtered()" [class.online]="isOnline(cam)"
        [class.offline]="!isOnline(cam)">

        <!-- Thumbnail / preview placeholder -->
        <div class="cam-thumb" (click)="isOnline(cam) && viewStream(cam.id)">
            <div class="cam-thumb-inner">
                <svg *ngIf="!isOnline(cam)" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5"
                    viewBox="0 0 24 24" style="color:#f87171;opacity:0.5;">
                    <path
                        d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39M10.71 5.05A16 16 0 0 1 22.56 9M1.42 9a15.91 15.91 0 0 1 4.7-2.88M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01" />
                </svg>
                <svg *ngIf="isOnline(cam)" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5"
                    viewBox="0 0 24 24" style="color:#34d399;opacity:0.5;">
                    <path d="M23 7l-7 5 7 5V7z" />
                    <rect x="1" y="5" width="15" height="14" rx="2" />
                </svg>
            </div>

            <!-- Live badge -->
            <div class="cam-live-badge" *ngIf="isOnline(cam)">
                <span class="live-dot"></span>EN VIVO
            </div>
            <div class="cam-offline-badge" *ngIf="!isOnline(cam)">SIN SE√ëAL</div>

            <!-- Stream type badge -->
            <div class="cam-type-badge" [class.cloud]="cam.streamType === 'cloud'"
                [class.nvr]="cam.streamType === 'nvr'" [class.sd]="cam.streamType === 'sd'">
                {{ cam.streamType === 'cloud' ? 'Cloud NAS' : cam.streamType === 'nvr' ? 'NVR' : 'SD Card' }}
            </div>
        </div>

        <!-- Card body -->
        <div class="cam-body">
            <div class="cam-name" [routerLink]="['/cameras', cam.id]">{{ cam.name }}</div>
            <div class="cam-meta">
                <span class="cam-location">üìç {{ cam.location || 'Sin ubicaci√≥n' }}</span>
                <span class="cam-gw">Gateway: <span class="mono">{{ cam.clientId ? 'Asignado' : '‚Äî' }}</span></span>
            </div>
            <div class="cam-rtsp" [title]="cam.rtspUrl">{{ cam.rtspUrl }}</div>

            <!-- Actions -->
            <div class="cam-actions">
                <button class="cam-btn-live" *ngIf="isOnline(cam)" (click)="viewStream(cam.id)">
                    <svg width="13" height="13" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M23 7l-7 5 7 5V7z" />
                        <rect x="1" y="5" width="15" height="14" rx="2" fill="none" stroke="currentColor"
                            stroke-width="2" />
                    </svg>
                    Ver en Vivo
                </button>
                <button class="cam-btn-rec" [routerLink]="['/recordings', cam.id]">üéû Grabaciones</button>
                <div class="cam-btn-more">
                    <button class="cam-btn-icon" (click)="openEdit(cam)" title="Editar">‚úèÔ∏è</button>
                    <button class="cam-btn-icon danger" (click)="deleteCamera(cam.id)" title="Eliminar">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EMPTY STATE -->
<div class="cam-empty" *ngIf="filtered().length === 0 && !cameras().length">
    <div class="empty-icon">üì∑</div>
    <h3>Sin c√°maras registradas</h3>
    <p>A√±ade una c√°mara IP con el bot√≥n de arriba para comenzar el streaming.</p>
    <button class="btn-primary" (click)="openCreate()">+ A√±adir Primera C√°mara</button>
</div>
<div class="cam-empty" *ngIf="filtered().length === 0 && cameras().length > 0">
    <div class="empty-icon">üîç</div>
    <h3>Sin resultados</h3>
    <p>No hay c√°maras que coincidan con los filtros seleccionados.</p>
</div>

<!-- MODAL FORMULARIO -->
<div class="modal-overlay" *ngIf="showModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ modalMode() === 'create' ? 'A√±adir C√°mara IP' : 'Editar C√°mara IP' }}</h2>
            <button class="close-btn" (click)="showModal.set(false)">‚úï</button>
        </div>
        <div class="modal-body" style="padding:24px;">
            <div class="form-row">
                <div class="form-group">
                    <label>Alias / Nombre</label>
                    <input type="text" [(ngModel)]="currentCamera().name" class="form-control"
                        placeholder="C√°mara Frontal">
                </div>
                <div class="form-group">
                    <label>Ubicaci√≥n F√≠sica</label>
                    <input type="text" [(ngModel)]="currentCamera().location" class="form-control"
                        placeholder="Pasillo A">
                </div>
            </div>
            <div class="form-group">
                <label>URL RTSP</label>
                <input type="text" [(ngModel)]="currentCamera().rtspUrl" class="form-control"
                    placeholder="rtsp://admin:pass@192.168.1.100:554/stream1">
            </div>
            <div class="form-group">
                <label>Asignar a Gateway / Cliente</label>
                <select [(ngModel)]="currentCamera().clientId" class="form-control">
                    <option value="">-- Sin Asignar --</option>
                    <option *ngFor="let client of clients()" [value]="client.id">{{ client.name }} ({{ client.gatewayId
                        }})</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" (click)="showModal.set(false)">Cancelar</button>
            <button class="btn-primary" (click)="saveCamera()">Guardar C√°mara</button>
        </div>
    </div>
</div>