<!-- ‚ö†Ô∏è M√ìDULO 1 ‚Äî SOLO Sistema de Monitoreo. SIN motores, SIN telemetr√≠a HMI. Ver AI_RULES.md -->

<!-- TOPBAR -->
<div class="topbar">
  <div>
    <h1>Dashboard Central</h1>
    <p class="subtitle">Monitoreo en tiempo real de nodos Edge IoT</p>
  </div>
  <div class="topbar-actions">
    <div class="health-pill" [class.healthy]="health().status === 'Healthy'"
      [class.unhealthy]="health().status !== 'Healthy'">
      <span class="health-dot"></span>
      <span>{{ health().status === 'Healthy' ? 'Sistema Operativo' : 'Sistema con alertas' }}</span>
    </div>
    <button class="btn-primary" (click)="refreshAll()">üîÑ Actualizar</button>
  </div>
</div>

<!-- STAT CARDS (4) -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon green">
      <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="2" y="3" width="20" height="14" rx="2" />
        <path d="M8 21h8M12 17v4" />
      </svg>
    </div>
    <div class="stat-body">
      <div class="stat-value">{{ stats().active }}<span class="stat-total"> / {{ stats().total }}</span></div>
      <div class="stat-label">Gateways Activos</div>
      <div class="stat-sub">nodos edge registrados</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon teal">
      <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M23 7l-7 5 7 5V7z" />
        <rect x="1" y="5" width="15" height="14" rx="2" />
      </svg>
    </div>
    <div class="stat-body">
      <div class="stat-value">{{ camerasOnline() }}</div>
      <div class="stat-label">C√°maras Online</div>
      <div class="stat-sub">transmitiendo ahora</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon red">
      <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path
          d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39M10.71 5.05A16 16 0 0 1 22.56 9M1.42 9a15.91 15.91 0 0 1 4.7-2.88M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01" />
      </svg>
    </div>
    <div class="stat-body">
      <div class="stat-value">{{ camerasOffline() }}</div>
      <div class="stat-label">C√°maras Offline</div>
      <div class="stat-sub">sin se√±al actualmente</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon blue">
      <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />
      </svg>
    </div>
    <div class="stat-body">
      <div class="stat-value">{{ cameras().length }}<span class="stat-total"> c√°ms</span></div>
      <div class="stat-label">Cloud NAS</div>
      <div class="stat-progress">
        <div class="stat-progress-bar"
          [style.width.%]="cameras().length > 0 ? (camerasOnline() / cameras().length) * 100 : 0"></div>
      </div>
    </div>
  </div>
</div>

<!-- GATEWAYS GRID -->
<div class="section-hdr">
  <h2>Gateways Edge</h2>
  <span class="section-count">{{ gateways().length }} nodos registrados</span>
</div>
<div class="gateways-grid">
  <div class="gw-card" *ngFor="let gw of gateways()" [class.online]="isActive(gw)" [class.offline]="!isActive(gw)">
    <div class="gw-header">
      <div class="gw-status-dot" [class.online]="isActive(gw)"></div>
      <div class="gw-name">{{ gw.name }}</div>
      <span class="badge" [class.online]="isActive(gw)" [class.offline]="!isActive(gw)">
        {{ isActive(gw) ? 'ACTIVO' : 'OFFLINE' }}
      </span>
    </div>
    <div class="gw-meta">
      <div class="gw-meta-row">
        <span class="gw-meta-key">ID Gateway</span>
        <span class="gw-meta-val mono">{{ gw.gatewayId }}</span>
      </div>
      <div class="gw-meta-row">
        <span class="gw-meta-key">Registrado</span>
        <span class="gw-meta-val">{{ gw.createdAt | date:'shortDate' }}</span>
      </div>
    </div>
    <div class="gw-cameras" *ngIf="isActive(gw)">
      <div class="gw-cam-label">C√°maras vinculadas</div>
      <div class="gw-cam-list">
        <button class="cam-chip online" *ngFor="let cam of getCamerasForGw(gw)"
          (click)="openCameraModal('/api/admin/stream/' + cam.id + '/hls')">
          <span class="cam-dot"></span>{{ cam.name }}
        </button>
        <span class="gw-no-cams" *ngIf="getCamerasForGw(gw).length === 0">Sin c√°maras asignadas</span>
      </div>
    </div>
    <div class="gw-offline-msg" *ngIf="!isActive(gw)">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39" />
      </svg>
      Nodo desconectado ‚Äî sin telemetr√≠a
    </div>
  </div>

  <div class="gateways-empty" *ngIf="gateways().length === 0">
    <div class="empty-icon">üñß</div>
    <h3>Sin gateways registrados</h3>
    <p>Configura un nuevo nodo edge desde el Wizard de instalaci√≥n.</p>
  </div>
</div>

<!-- ACTIVIDAD RECIENTE -->
<div class="section-hdr" style="margin-top: 32px;">
  <h2>Actividad Reciente</h2>
  <span class="section-count">√öltimos eventos del sistema</span>
</div>
<div class="activity-table-wrap">
  <table class="activity-table">
    <thead>
      <tr>
        <th>Evento</th>
        <th>Gateway</th>
        <th>Estado</th>
        <th>Hora</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let ev of recentActivity()">
        <td class="font-medium">{{ ev.event }}</td>
        <td class="text-muted mono">{{ ev.gateway }}</td>
        <td><span class="badge" [class.online]="ev.type === 'online'" [class.offline]="ev.type === 'offline'"
            [class.active]="ev.type === 'info'">{{ ev.label }}</span></td>
        <td class="text-muted">{{ ev.time | date:'HH:mm:ss' }}</td>
      </tr>
      <tr *ngIf="recentActivity().length === 0">
        <td colspan="4" class="empty-state">Sin eventos registrados a√∫n</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- MODAL VISOR -->
<div class="modal-overlay" *ngIf="selectedCameraStream" (click)="closeCameraModal()">
  <div class="modal-content cam-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Visualizaci√≥n en Vivo</h3>
      <button class="close-btn" (click)="closeCameraModal()">‚úï</button>
    </div>
    <div class="modal-body" style="padding:0;">
      <app-camera-viewer [streamUrl]="selectedCameraStream"></app-camera-viewer>
    </div>
  </div>
</div>