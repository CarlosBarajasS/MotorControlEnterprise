<div class="topbar">
    <div>
        <h1>Gesti√≥n de Clientes (Gateways)</h1>
        <p class="subtitle">Administra los dispositivos edge vinculados, su estado de almacenamiento y telemetr√≠a.</p>
    </div>
    <div style="display: flex; gap: 12px;">
        <button class="btn-primary" (click)="openCreate()">+ Nuevo Cliente</button>
        <button class="btn-secondary" (click)="loadData()">üîÑ Actualizar</button>
    </div>
</div>

<div class="stats-grid" *ngIf="stats()">
    <div class="stat-card">
        <span class="label">Total Clientes</span>
        <span class="value">{{ stats().clients?.total || 0 }}</span>
    </div>
    <div class="stat-card">
        <span class="label">Activos</span>
        <span class="value success">{{ stats().clients?.active || 0 }}</span>
    </div>
    <div class="stat-card">
        <span class="label">Almacenamiento Total</span>
        <span class="value">{{ stats().storage?.totalTb || "0" }} TB</span>
    </div>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Tipo Negocio</th>
                <th>Gateway ID</th>
                <th>Estado</th>
                <th>Grabaci√≥n Cloud</th>
                <th>Creaci√≥n</th>
                <th class="text-right">Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngIf="clients().length === 0">
                <td colspan="7" class="text-center empty-state">No hay clientes registrados en el sistema.</td>
            </tr>
            <tr *ngFor="let client of clients()">
                <td class="font-medium">
                    <a [routerLink]="['/clients', client.id]" style="color:var(--accent); text-decoration:none;">{{
                        client.name }}</a>
                </td>
                <td>{{ client.businessType || 'N/A' }}</td>
                <td class="mono-text">{{ client.gatewayId || 'Asignar' }}</td>
                <td>
                    <span class="badge"
                        [ngClass]="{'active': client.status === 'active', 'inactive': client.status !== 'active'}"
                        (click)="toggleStatus(client)" title="Clic para cambiar estado">
                        {{ client.status | uppercase }}
                    </span>
                </td>
                <td>
                    <label class="toggle-switch">
                        <input type="checkbox" [checked]="client.cloudStorageActive"
                            (change)="toggleCloudStorage(client)">
                        <span class="slider"></span>
                    </label>
                </td>
                <td class="text-muted">{{ client.createdAt | date:'shortDate' }}</td>
                <td class="actions-cell">
                    <button class="action-btn edit" (click)="openEdit(client)">Editar</button>
                    <button class="action-btn delete" (click)="deleteClient(client.id)">Borrar</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>


<!-- Modal Formulario -->
<div class="modal-overlay" *ngIf="showModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{{ modalMode() === 'create' ? 'Crear Nuevo Cliente' : 'Editar Cliente' }}</h2>
            <button class="close-btn" (click)="showModal.set(false)">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Raz√≥n Social / Nombre</label>
                <input type="text" [(ngModel)]="currentClient().name" class="form-control"
                    placeholder="Empresa S.A. de C.V.">
            </div>
            <div class="form-group">
                <label>Tipo de Negocio</label>
                <input type="text" [(ngModel)]="currentClient().businessType" class="form-control"
                    placeholder="Retail, Bodega, etc.">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>RFC</label>
                    <input type="text" [(ngModel)]="currentClient().rfc" class="form-control">
                </div>
                <div class="form-group">
                    <label>Ciudad</label>
                    <input type="text" [(ngModel)]="currentClient().city" class="form-control">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" (click)="showModal.set(false)">Cancelar</button>
            <button class="btn-primary" (click)="saveClient()">Guardar Datos</button>
        </div>
    </div>
</div>