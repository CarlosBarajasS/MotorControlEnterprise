<div class="clients-layout">
    <div class="topbar">
        <div>
            <h1>Gesti√≥n de Clientes (Gateways)</h1>
            <p class="subtitle">Administra los dispositivos edge vinculados, su estado de almacenamiento y telemetr√≠a.
            </p>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn-primary" (click)="openCreate()">+ Nuevo Cliente</button>
            <button class="btn-secondary" (click)="loadData()">üîÑ Actualizar</button>
        </div>
    </div>

    <div class="stats-grid" *ngIf="stats()">
        <div class="stat-card">
            <span class="label">Total Clientes</span>
            <span class="value">{{ stats().clients?.total || 0 }}</span>
        </div>
        <div class="stat-card">
            <span class="label">Activos</span>
            <span class="value success">{{ stats().clients?.active || 0 }}</span>
        </div>
        <div class="stat-card">
            <span class="label">Almacenamiento Total</span>
            <span class="value">{{ stats().storage?.totalTb || "0" }} TB</span>
        </div>
    </div>

    <div style="margin-bottom:16px; display:flex; gap:12px; align-items:center;">
        <input type="text" class="form-control" placeholder="üîç Buscar cliente..." [ngModel]="searchTerm()"
            (ngModelChange)="searchTerm.set($event)" style="max-width:320px;">
        <span style="font-size:13px; color:var(--muted);">{{ filtered().length }} clientes</span>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tipo Negocio</th>
                    <th>Ubicaci√≥n</th>
                    <th>Contacto</th>
                    <th>Gateway ID</th>
                    <th>Estado</th>
                    <th>Grabaci√≥n Cloud</th>
                    <th>Creaci√≥n</th>
                    <th class="text-right">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngIf="filtered().length === 0">
                    <td colspan="9" class="text-center empty-state">No hay clientes registrados en el sistema.</td>
                </tr>
                <tr *ngFor="let client of filtered()">
                    <td class="font-medium">
                        <a [routerLink]="['/clients', client.id]" class="client-link">{{
                            client.name }}</a>
                    </td>
                    <td>{{ client.businessType || 'N/A' }}</td>
                    <td>{{ client.city || '‚Äî' }}{{ client.state ? ', ' + client.state : '' }}</td>
                    <td>
                        <div style="font-size:13px;">{{ client.contactName || '‚Äî' }}</div>
                        <div style="font-size:11px; color:var(--muted);">{{ client.contactPhone || '' }}</div>
                    </td>
                    <td class="mono-text">{{ client.gatewayId || 'Asignar' }}</td>
                    <td>
                        <span class="badge"
                            [ngClass]="{'active': client.status === 'active', 'inactive': client.status !== 'active'}"
                            (click)="toggleStatus(client)" title="Clic para cambiar estado">
                            {{ client.status | uppercase }}
                        </span>
                    </td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" [checked]="client.cloudStorageActive"
                                (change)="toggleCloudStorage(client)">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="text-muted">{{ client.createdAt | date:'shortDate' }}</td>
                    <td class="actions-cell">
                        <button class="action-btn edit" (click)="openEdit(client)">Editar</button>
                        <button class="action-btn delete" (click)="deleteClient(client.id)">Borrar</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>


    <!-- Modal Formulario -->
    <div class="modal-overlay" *ngIf="showModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>{{ modalMode() === 'create' ? 'Crear Nuevo Cliente' : 'Editar Cliente' }}</h2>
                <button class="close-btn" (click)="showModal.set(false)">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Raz√≥n Social / Nombre</label>
                    <input type="text" [(ngModel)]="currentClient().name" class="form-control"
                        placeholder="Empresa S.A. de C.V.">
                </div>
                <div class="form-group">
                    <label>Tipo de Negocio</label>
                    <select [(ngModel)]="currentClient().businessType" class="form-control">
                        <option value="">-- Seleccionar --</option>
                        <option value="Retail">Retail</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Oficina">Oficina</option>
                        <option value="Bodega">Bodega</option>
                        <option value="Manufactura">Manufactura</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" [(ngModel)]="currentClient().rfc" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Ciudad</label>
                        <input type="text" [(ngModel)]="currentClient().city" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado</label>
                        <input type="text" [(ngModel)]="currentClient().state" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Pa√≠s</label>
                        <input type="text" [(ngModel)]="currentClient().country" class="form-control"
                            placeholder="M√©xico">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Contacto</label>
                        <input type="text" [(ngModel)]="currentClient().contactName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" [(ngModel)]="currentClient().contactPhone" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Email del Contacto</label>
                    <input type="email" [(ngModel)]="currentClient().contactEmail" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="showModal.set(false)">Cancelar</button>
                <button class="btn-primary" (click)="saveClient()">Guardar Datos</button>
            </div>
        </div>
    </div>
</div>