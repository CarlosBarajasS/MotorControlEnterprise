<div class="topbar">
    <div>
        <a routerLink="/clients" class="back-link">‚Üê Volver a Gateways</a>
        <h1>Detalle del Gateway/Edge: {{ clientData()?.name || '...' }}</h1>
        <p class="subtitle">Monitoreo espec√≠fico e infraestructura conectada a este nodo.</p>
    </div>
    <div style="display: flex; gap: 12px; align-items:center;">
        <span class="badge" *ngIf="clientData()" [class.online]="clientData()?.status === 'active'"
            [class.offline]="clientData()?.status !== 'active'">
            {{ (clientData()?.status || 'desconocido') | uppercase }}
        </span>
        <button class="btn-primary" (click)="openEdgeConfig()" style="display:inline-flex;align-items:center;gap:8px;">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path
                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
            Configurar Edge
        </button>
        <button class="btn-secondary" (click)="loadClientDetails()">üîÑ Refrescar</button>
    </div>
</div>

<div class="stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 24px;"
    *ngIf="!loading()">
    <div class="card" style="padding: 1.5rem;">
        <span
            style="font-size: 0.85rem; color: var(--muted); display: block; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Tipo
            Negocio</span>
        <strong style="font-size: 1.4rem; color: var(--ink);">{{ clientData()?.businessType || 'N/A' }}</strong>
    </div>
    <div class="card" style="padding: 1.5rem;">
        <span
            style="font-size: 0.85rem; color: var(--muted); display: block; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Gateway
            ID</span>
        <strong style="font-size: 1.4rem; color: var(--ink); font-family: monospace;">{{ clientData()?.gatewayId ||
            'N/A' }}</strong>
    </div>
    <div class="card" style="padding: 1.5rem;">
        <span
            style="font-size: 0.85rem; color: var(--muted); display: block; margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase;">Almacenamiento
            Local/Nube</span>
        <strong style="font-size: 1.4rem; color: var(--ink);">{{ clientData()?.cloudStorageActive ? 'Habilitado' : 'Solo
            Local' }}</strong>
    </div>
</div>

<!-- ADMIN-2: Cloud Storage Toggle -->
<div class="card"
    style="padding: 20px; margin-bottom: 24px; display:flex; justify-content:space-between; align-items:center;"
    *ngIf="!loading()">
    <div>
        <h3 style="margin:0 0 4px; font-size:1rem;">‚òÅÔ∏è Grabaci√≥n en Nube</h3>
        <p style="margin:0; font-size:13px; color:var(--muted);">Graba segmentos de 15 min continuamente al servidor NAS
            central</p>
    </div>
    <label class="toggle-switch">
        <input type="checkbox" [checked]="clientData()?.cloudStorageActive" (change)="toggleCloudStorage($event)">
        <span class="slider"></span>
    </label>
</div>

<div class="card" style="padding: 24px;" *ngIf="!loading()">
    <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 1.15rem;">C√°maras Asociadas</h3>
    <table class="data-table" style="width: 100%; text-align: left; border-collapse: collapse;">
        <thead>
            <tr
                style="border-bottom: 1px solid var(--outline); color: var(--muted); font-size: 0.85rem; text-transform: uppercase;">
                <th style="padding: 12px 0; font-weight: 600;">Nombre del Feed</th>
                <th style="padding: 12px 0; font-weight: 600;">Estado RTSP</th>
                <th style="padding: 12px 0; font-weight: 600;">√öltima Conexi√≥n</th>
                <th style="padding: 12px 0; font-weight: 600; text-align: right;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngIf="cameras().length === 0">
                <td colspan="4" style="text-align: center; padding: 24px; color: var(--muted);">No hay c√°maras
                    vinculadas a este nodo todav√≠a.</td>
            </tr>
            <tr *ngFor="let cam of cameras()" style="border-bottom: 1px solid var(--outline);">
                <td style="padding: 12px 0; font-weight: 500;">
                    <a [routerLink]="['/cameras', cam.id]" class="client-link">{{
                        cam.name }}</a>
                </td>
                <td style="padding: 12px 0;">
                    <span class="badge" [class.online]="cam.status === 'online'"
                        [class.offline]="cam.status !== 'online'">
                        {{ (cam.status || 'OFFLINE') | uppercase }}
                    </span>
                </td>
                <td style="padding: 12px 0; color: var(--muted);">{{ cam.lastSeen ? (cam.lastSeen | date:'short') :
                    'N/A' }}</td>
                <td style="padding: 12px 0; text-align: right; display:flex; gap:6px; justify-content:end;">
                    <button class="btn-secondary"
                        style="font-size: 12px; padding: 6px 12px; border-color:transparent; background:rgba(37,99,235,0.08); color:var(--accent);"
                        [routerLink]="['/cameras', cam.id]">üëÅ Ver En Vivo</button>
                    <button class="btn-secondary" style="font-size: 12px; padding: 6px 12px;"
                        [routerLink]="['/recordings', cam.id]">Grabaciones</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDGE CONFIG MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" *ngIf="showEdgeConfig()" (click)="closeEdgeConfig()">
    <div class="modal-content edge-config-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h2 style="margin:0; font-size:20px;">‚öôÔ∏è Configuraci√≥n Edge Gateway</h2>
                <p style="color:var(--muted); font-size:13px; margin:4px 0 0;">Archivos generados por el servidor para
                    <strong>{{ clientData()?.name }}</strong>
                </p>
            </div>
            <button class="modal-close" (click)="closeEdgeConfig()">‚úï</button>
        </div>

        <div *ngIf="edgeConfigLoading()" style="text-align:center; padding:60px 0; color:var(--muted);">
            <div class="spinner"></div>
            <p style="margin-top:16px;">Generando archivos de configuraci√≥n...</p>
        </div>

        <div *ngIf="!edgeConfigLoading() && edgeConfig()">
            <!-- MQTT Credentials -->
            <div class="mqtt-credentials">
                <div class="mqtt-title">
                    <svg width="18" height="18" fill="none" stroke="#f59e0b" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 9v2m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />
                    </svg>
                    Credenciales MQTT ‚Äî Agregar al servidor Mosquitto
                </div>
                <div class="mqtt-grid">
                    <div class="mqtt-field">
                        <span class="mqtt-label">Usuario</span>
                        <code class="mqtt-value">{{ edgeConfig().mqttUsername }}</code>
                        <button class="copy-btn" (click)="copyToClipboard(edgeConfig().mqttUsername)">üìã</button>
                    </div>
                    <div class="mqtt-field">
                        <span class="mqtt-label">Contrase√±a</span>
                        <code class="mqtt-value">{{ edgeConfig().mqttPassword }}</code>
                        <button class="copy-btn" (click)="copyToClipboard(edgeConfig().mqttPassword)">üìã</button>
                    </div>
                    <div class="mqtt-field full">
                        <span class="mqtt-label">L√≠nea para password_file</span>
                        <code class="mqtt-value mono">{{ edgeConfig().mosquittoLine }}</code>
                        <button class="copy-btn" (click)="copyToClipboard(edgeConfig().mosquittoLine)">üìã</button>
                    </div>
                </div>
            </div>

            <!-- File Tabs -->
            <div class="file-tabs">
                <button class="file-tab" [class.active]="edgeConfigTab() === 'env'"
                    (click)="setEdgeTab('env')">.env</button>
                <button class="file-tab" [class.active]="edgeConfigTab() === 'compose'"
                    (click)="setEdgeTab('compose')">docker-compose.yml</button>
                <button class="file-tab" [class.active]="edgeConfigTab() === 'mediamtx'"
                    (click)="setEdgeTab('mediamtx')">mediamtx.yml</button>
                <span class="copy-feedback" *ngIf="copyFeedback()">{{ copyFeedback() }}</span>
            </div>

            <div class="code-preview">
                <pre>{{ getActiveFileContent() }}</pre>
                <div class="code-actions">
                    <button class="btn-secondary" style="font-size:12px; padding:6px 14px;"
                        (click)="copyToClipboard(getActiveFileContent())">üìã Copiar</button>
                    <button class="btn-primary" style="font-size:12px; padding:6px 14px;"
                        (click)="downloadEdgeFile(edgeConfigTab())">‚¨á Descargar</button>
                </div>
            </div>

            <!-- Deploy Instructions -->
            <div class="deploy-instructions">
                <h4 style="margin:0 0 12px; font-size:14px;">üìå Instrucciones de despliegue</h4>
                <ol style="margin:0; padding-left:20px; font-size:13px; line-height:2; color:var(--muted);">
                    <li>Agrega la l√≠nea <code>{{ edgeConfig().mosquittoLine }}</code> al archivo
                        <code>password_file</code> de Mosquitto y reinicia el servicio.
                    </li>
                    <li>Descarga los 3 archivos y c√≥pialos a la Raspberry Pi dentro de la carpeta
                        <code>edge-gateway/</code>.
                    </li>
                    <li>Ejecuta <code>docker compose up -d</code> para iniciar el gateway.</li>
                    <li>Verifica en <strong>Dashboard ‚Üí C√°maras</strong> que las c√°maras aparezcan en l√≠nea (~2 min).
                    </li>
                </ol>
            </div>
        </div>

        <div *ngIf="!edgeConfigLoading() && !edgeConfig()" style="text-align:center; padding:40px; color:var(--red);">
            <p>‚ùå No se pudo obtener la configuraci√≥n. Verifica que el backend est√© activo.</p>
            <button class="btn-secondary" style="margin-top:12px;" (click)="openEdgeConfig()">Reintentar</button>
        </div>
    </div>
</div>