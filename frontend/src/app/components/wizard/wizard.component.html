<div class="wizard-container">
    <div class="wizard-header">
        <h1>Alta de Nuevo Cliente</h1>
        <p>Genera la configuraci√≥n completa para instalar el edge gateway en el sitio del cliente</p>
    </div>

    <div class="progress-container">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-fill" [style.width.%]="(currentStep() - 1) / (totalSteps - 1) * 100"></div>
            </div>
            <div class="step" [class.active]="currentStep() === 1" [class.completed]="currentStep() > 1">
                <div class="step-circle">1</div>
                <div class="step-label">Cliente</div>
            </div>
            <div class="step" [class.active]="currentStep() === 2" [class.completed]="currentStep() > 2">
                <div class="step-circle">2</div>
                <div class="step-label">C√°maras</div>
            </div>
            <div class="step" [class.active]="currentStep() === 3" [class.completed]="currentStep() > 3">
                <div class="step-circle">3</div>
                <div class="step-label">Archivos</div>
            </div>
            <div class="step" [class.active]="currentStep() === 4" [class.completed]="currentStep() > 4">
                <div class="step-circle">4</div>
                <div class="step-label">Despliegue</div>
            </div>
            <div class="step" [class.active]="currentStep() === 5" [class.completed]="currentStep() > 5">
                <div class="step-circle">5</div>
                <div class="step-label">Acceso Web</div>
            </div>
        </div>
    </div>

    <div class="wizard-content">

        <!-- Step 1: Datos del cliente -->
        @if (currentStep() === 1) {
        <div class="wizard-step">
            <h2 class="step-title">Datos del Cliente</h2>
            <p class="step-description">Informaci√≥n b√°sica del negocio donde se instalar√°n las c√°maras</p>

            @if (alerts()[1]) {
            <div class="alert" [ngClass]="alerts()[1].type">{{ alerts()[1].message }}</div>
            }

            <div class="form-row">
                <div class="form-group" [class.error]="clientErrors().name">
                    <label>Nombre del negocio <span class="required">*</span></label>
                    <input type="text" [(ngModel)]="clientData.name" (blur)="updateGatewayId()"
                        placeholder="Ej: Tienda La Esperanza" autocomplete="off">
                    <div class="error-message">Este campo es requerido</div>
                </div>
                <div class="form-group" [class.error]="clientErrors().businessType">
                    <label>Tipo de negocio <span class="required">*</span></label>
                    <select [(ngModel)]="clientData.businessType">
                        <option value="">Selecciona...</option>
                        <option value="Retail">Retail / Tienda</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Oficina">Oficina</option>
                        <option value="F√°brica">F√°brica</option>
                        <option value="Almac√©n">Almac√©n</option>
                        <option value="Educaci√≥n">Educaci√≥n</option>
                        <option value="Salud">Salud</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <div class="error-message">Selecciona un tipo</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" [class.error]="clientErrors().contactName">
                    <label>Nombre de contacto <span class="required">*</span></label>
                    <input type="text" [(ngModel)]="clientData.contactName" placeholder="Ej: Juan P√©rez">
                    <div class="error-message">Este campo es requerido</div>
                </div>
                <div class="form-group">
                    <label>Tel√©fono de contacto</label>
                    <input type="tel" [(ngModel)]="clientData.contactPhone" placeholder="+52 443 123 4567">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group" [class.error]="clientErrors().location">
                    <label>Direcci√≥n / Ubicaci√≥n <span class="required">*</span></label>
                    <input type="text" [(ngModel)]="clientData.location"
                        placeholder="Ej: Av. Madero 123, Morelia, Michoac√°n">
                    <div class="error-message">Este campo es requerido</div>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group" [class.error]="clientErrors().gatewayId">
                    <label>ID del Gateway <span class="required">*</span></label>
                    <input type="text" [(ngModel)]="clientData.gatewayId" placeholder="edge-gateway-tienda-esperanza">
                    <div class="hint">Se genera autom√°ticamente del nombre. Sin espacios ni caracteres especiales. Es el
                        identificador √∫nico en el sistema.</div>
                    <div class="error-message">Este campo es requerido</div>
                </div>
            </div>
            <div class="storage-config">
                <h3 class="storage-title">üíæ Configuraci√≥n de Almacenamiento</h3>

                <!-- Cloud Toggle -->
                <div class="storage-option cloud-option">
                    <input type="checkbox" [(ngModel)]="clientData.cloudStorageActive" id="cloudToggle"
                        style="width:18px;height:18px;accent-color:#6366f1;flex-shrink:0;">
                    <div>
                        <label for="cloudToggle" style="font-weight:600;font-size:13px;cursor:pointer;">‚òÅÔ∏è Activar
                            grabaci√≥n en nube (NAS)</label>
                        <div class="hint" style="margin:0;">Las grabaciones se sincronizan al servidor central para
                            archivado de largo plazo.</div>
                    </div>
                </div>

                <!-- Local Storage Type -->
                <div class="storage-local-selector">
                    <label style="font-weight:600;font-size:13px;display:block;margin-bottom:10px;">üì¶
                        Almacenamiento local del sitio</label>
                    <div class="radio-group">
                        <label class="radio-card" [class.selected]="clientData.localStorageType === 'nvr'">
                            <input type="radio" name="localStorageType" value="nvr"
                                [(ngModel)]="clientData.localStorageType">
                            <div class="radio-content">
                                <strong>üìπ NVR (Grabador en Red)</strong>
                                <span>Para c√°maras IP ‚Äî Hikvision, Dahua, etc.</span>
                            </div>
                        </label>
                        <label class="radio-card" [class.selected]="clientData.localStorageType === 'dvr'">
                            <input type="radio" name="localStorageType" value="dvr"
                                [(ngModel)]="clientData.localStorageType">
                            <div class="radio-content">
                                <strong>üìº DVR (Grabador Anal√≥gico)</strong>
                                <span>Para c√°maras anal√≥gicas con cable coaxial</span>
                            </div>
                        </label>
                        <label class="radio-card" [class.selected]="clientData.localStorageType === 'none'">
                            <input type="radio" name="localStorageType" value="none"
                                [(ngModel)]="clientData.localStorageType">
                            <div class="radio-content">
                                <strong>üö´ Sin equipo local</strong>
                                <span>Solo streaming en vivo + respaldo en nube</span>
                            </div>
                        </label>
                    </div>
                    <div class="hint" style="margin-top:8px;">El acceso a grabaciones locales es directo desde
                        el monitor conectado al NVR/DVR, sin necesidad de internet.</div>
                </div>

                <!-- NVR/DVR Connection Fields (for edge .env generation) -->
                @if (clientData.localStorageType === 'nvr' || clientData.localStorageType === 'dvr') {
                <div class="nvr-fields" style="margin-top:12px;">
                    <label style="font-weight:600;font-size:13px;display:block;margin-bottom:10px;">
                        üîå Datos del {{ clientData.localStorageType === 'nvr' ? 'NVR' : 'DVR' }}
                        <small style="font-weight:400;color:var(--muted);display:block;margin-top:2px;">
                            Se usan para generar la configuraci√≥n del edge gateway</small>
                    </label>
                    <div class="form-row">
                        <div class="form-group">
                            <label>IP en red local</label>
                            <input type="text" [(ngModel)]="clientData.nvrIp" placeholder="192.168.1.64">
                        </div>
                        <div class="form-group" style="max-width:120px;">
                            <label>Puerto</label>
                            <input type="number" [(ngModel)]="clientData.nvrPort" placeholder="80">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" [(ngModel)]="clientData.nvrUser" placeholder="admin">
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a</label>
                            <input type="password" [(ngModel)]="clientData.nvrPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label>Marca</label>
                            <select [(ngModel)]="clientData.nvrBrand">
                                <option value="hikvision">Hikvision</option>
                                <option value="dahua">Dahua</option>
                                <option value="generic">Otro / Gen√©rico</option>
                            </select>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
        }


        <!-- Step 2: C√°maras -->
        @if (currentStep() === 2) {
        <div class="wizard-step">
            <h2 class="step-title">C√°maras IP</h2>
            <p class="step-description">Define las c√°maras que se van a conectar en la red local del cliente</p>

            @if (alerts()[2]) {
            <div class="alert" [ngClass]="alerts()[2].type">{{ alerts()[2].message }}</div>
            }

            <div class="alert info" style="display:block">
                Las c√°maras deben estar accesibles desde el dispositivo donde se instalar√° el edge gateway (misma red
                local por el mismo medio f√≠sico).
            </div>

            <div id="camerasList">
                @for (cam of cameras(); track $index) {
                <div class="camera-card">
                    <div class="camera-card-header">
                        <div class="camera-card-title">C√°mara {{ $index + 1 }}</div>
                        <button class="btn-remove" (click)="removeCamera($index)">Eliminar</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ID/Nombre <span class="required">*</span></label>
                            <input type="text" [(ngModel)]="cam.id" placeholder="cam1">
                        </div>
                        <div class="form-group">
                            <label>IP Local <span class="required">*</span></label>
                            <input type="text" [(ngModel)]="cam.ip" placeholder="192.168.1.100">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Usuario RTSP</label>
                            <input type="text" [(ngModel)]="cam.user" placeholder="admin">
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a RTSP</label>
                            <input type="text" [(ngModel)]="cam.password" placeholder="******">
                        </div>
                    </div>
                    <div class="form-row full" style="margin-bottom:0">
                        <div class="form-group" style="margin-bottom:0">
                            <label>Ruta RTSP <span class="required">*</span></label>
                            <input type="text" [(ngModel)]="cam.rtspPath" placeholder="/Streaming/Channels/101">
                        </div>
                    </div>
                </div>
                }
            </div>

            <button class="btn btn-secondary" style="margin-top: 10px;" (click)="addCamera()">+ Agregar c√°mara</button>
        </div>
        }

        <!-- Step 3: Archivos generados -->
        @if (currentStep() === 3) {
        <div class="wizard-step">
            <h2 class="step-title">Archivos de Configuraci√≥n</h2>
            <p class="step-description">Revisa y descarga los archivos que debes copiar al dispositivo edge (Raspberry
                Pi / NUC)</p>

            <div class="file-tab">
                <button class="tab-btn" [class.active]="activeTab() === 'env'" (click)="showTab('env')">.env</button>
                <button class="tab-btn" [class.active]="activeTab() === 'mediamtx'"
                    (click)="showTab('mediamtx')">mediamtx/mediamtx.yml</button>
                <button class="tab-btn" [class.active]="activeTab() === 'compose'"
                    (click)="showTab('compose')">docker-compose.yml</button>
            </div>

            <div class="code-block">
                @if (activeTab() === 'env') { {{ generatedFiles().env }} }
                @if (activeTab() === 'mediamtx') { {{ generatedFiles().mediamtx }} }
                @if (activeTab() === 'compose') { {{ generatedFiles().compose }} }
            </div>

            <div class="download-btns">
                <button class="btn btn-primary" (click)="downloadFile('env')">Descargar .env</button>
                <button class="btn btn-primary" (click)="downloadFile('mediamtx')">Descargar mediamtx.yml</button>
                <button class="btn btn-primary" (click)="downloadFile('compose')">Descargar docker-compose.yml</button>
            </div>
        </div>
        }

        <!-- Step 4: Instrucciones de despliegue -->
        @if (currentStep() === 4) {
        <div class="wizard-step">
            <h2 class="step-title">Instrucciones de Instalaci√≥n</h2>
            <p class="step-description">Pasos para instalar el equipo en la ubicaci√≥n de
                <strong>{{clientData.name}}</strong>. Realiza esto en la Raspberry Pi del cliente.
            </p>

            <div class="alert success" style="display:block; color: rgb(21, 128, 61);">
                ‚úÖ Cliente registrado correctamente en el MotorControlAPI. Descarga los archivos del Paso 4 antes de
                irte.
            </div>

            <div class="deploy-step">
                <div class="deploy-step-num">1</div>
                <div class="deploy-step-content">
                    <strong>Descargar el software base del gateway</strong>
                    <p>En la consola de la Raspberry Pi ejecutamos esto:</p>
                    <code
                        class="cmd">git clone https://github.com/CarlosBarajasS/motorcontrol-edge-template.git edge-gateway && cd edge-gateway</code>
                </div>
            </div>

            <div class="deploy-step">
                <div class="deploy-step-num">2</div>
                <div class="deploy-step-content">
                    <strong>Copiar los archivos de configuraci√≥n del cliente</strong>
                    <p>Trasfiere los 3 archivos descargados v√≠a SFTP o USB, y reempl√°zalos sobre la carpeta actual
                        <code>edge-gateway</code> asegur√°ndote de colocar <code>mediamtx.yml</code> dentro del
                        subdirectorio <code>mediamtx/</code>.
                    </p>
                </div>
            </div>

            <div class="deploy-step">
                <div class="deploy-step-num">3</div>
                <div class="deploy-step-content">
                    <strong>Iniciar el contenedor Docker</strong>
                    <p>Iniciamos el servicio en background de forma desatendida.</p>
                    <code class="cmd">docker compose up -d</code>
                </div>
            </div>

            <div class="deploy-step">
                <div class="deploy-step-num">4</div>
                <div class="deploy-step-content">
                    <strong>Verificar</strong>
                    <p>El enlace Heartbeat se validar√° en menos de dos minutos. Podremos verlo en l√≠nea en el listado de
                        Gateways.</p>
                    <code class="cmd">docker logs edge-agent --tail=20 -f</code>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <button class="btn btn-secondary" routerLink="/clients">Ir a lista de Clientes</button>
            </div>
        </div>
        }

        <!-- Step 5: Acceso Web (Nuevo final) -->
        @if (currentStep() === 5) {
        <div class="wizard-step">
            <h2 class="step-title">Crear acceso web del cliente</h2>
            <p class="step-description">Genera la cuenta administrativa para el cliente (requerir√° cambio obligatorio
                tras el primer login)</p>

            @if (alerts()[5]) {
            <div class="alert" [ngClass]="alerts()[5].type">{{ alerts()[5].message }}</div>
            }

            @if (userCreated()) {
            <div class="alert success"
                style="display:block; color: rgb(21, 128, 61); border: 1px solid rgba(21, 128, 61, 0.2);">
                <div style="font-weight: 600; margin-bottom: 8px;">‚úÖ Acceso ya configurado</div>
                El usuario <strong>{{ userData.email }}</strong> fue creado exitosamente. <br><br>
                El cliente puede ingresar al portal web ahora mismo; nuestro sistema le pedir√° que asigne una nueva
                contrase√±a en su primer inicio de sesi√≥n por motivos de seguridad.
            </div>
            <div style="margin-top: 24px; text-align: center;">
                <button class="btn btn-primary" routerLink="/clients" style="margin-right: 12px;">Finalizar e ir a
                    Clientes</button>
                <button class="btn btn-secondary" routerLink="/cameras">Ver c√°maras ‚Üí</button>
            </div>
            } @else {
            <div class="form-row">
                <div class="form-group" [class.error]="userErrors().email">
                    <label>Email de acceso <span class="required">*</span></label>
                    <input type="email" [(ngModel)]="userData.email" placeholder="cliente@empresa.com">
                    <div class="error-message">Ingresa un email v√°lido</div>
                </div>
                <div class="form-group" [class.error]="userErrors().name">
                    <label>Nombre del Responsable <span class="required">*</span></label>
                    <input type="text" [(ngModel)]="userData.name" placeholder="Ej: Administrador General">
                    <div class="error-message">Este campo es requerido</div>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group" [class.error]="userErrors().password">
                    <label>Contrase√±a Temporal <span class="required">*</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" [(ngModel)]="userData.password" placeholder="M√≠nimo 8 caracteres"
                            style="flex: 1;">
                        <button class="btn btn-secondary" (click)="generateRandomPassword()"
                            style="white-space: nowrap;">Generar autom√°ticamente</button>
                    </div>
                    <div class="error-message">M√≠nimo 8 caracteres</div>
                    <div class="hint" style="margin-top: 6px;">Esta contrase√±a ser√° enviada por correo al cliente como
                        clave de un solo uso.</div>
                </div>
            </div>
            }
        </div>
        }

    </div>

    <!-- Navigation Footer -->
    <div class="wizard-nav">
        <button class="btn btn-secondary" [disabled]="currentStep() === 1" (click)="prevStep()">‚Üê Anterior</button>
        <span class="step-counter">Paso <span>{{currentStep()}}</span> de 5</span>

        <button class="btn btn-primary" (click)="nextStep()" [disabled]="isCreatingUser()">
            @if (isCreatingUser()) {
            Procesando...
            } @else {
            @if (currentStep() === 5 && !userCreated()) { Crear acceso y enviar email }
            @else if (currentStep() === 5 && userCreated()) { Terminado }
            @else { Siguiente ‚Üí }
            }
        </button>
    </div>
</div>