<div class="clients-layout drive-layout">

  <!-- DRIVE SIDEBAR (Tree Navigation) -->
  <div class="drive-sidebar">
    <div class="drive-section">
      <h3 class="drive-title">Explorador NAS</h3>

      <ul class="drive-tree">
        <li class="tree-item">
          <span class="tree-icon">üìÇ</span>
          <a routerLink="/cameras" style="color:inherit;text-decoration:none;">C√°maras Edge</a>
        </li>
        <ul class="tree-sub">
          <ng-container *ngFor="let cam of recordingCameras()">
            <li class="tree-item" [class.expanded]="cam.id.toString() === cameraId()" style="cursor: pointer;"
              (click)="navigateToCamera(cam.id)">
              <span class="tree-icon">üìπ</span>
              <span class="text-truncate">{{ cam.name }}</span>
              <span *ngIf="!cam.cloudStorageActive" class="storage-inactive-badge"
                style="margin-left:auto; font-size:10px; color:#ef4444;" title="Almacenamiento Inactivo">‚ùå
                INACTIVO</span>
            </li>

            <!-- Sub-carpeta: Fechas (Only if the camera is selected) -->
            <ul class="tree-sub" *ngIf="cam.id.toString() === cameraId()">
              <li class="tree-item date-item" *ngFor="let d of availableDates()" [class.active]="d === selectedDate()"
                (click)="selectDate(d)">
                <span class="tree-icon">üìÅ</span> {{ d }}
              </li>
              <li class="tree-item empty" *ngIf="availableDates().length === 0">
                <span class="tree-icon" style="opacity:0">‚îî</span> Sin carpetas de fecha
              </li>
            </ul>
          </ng-container>
          <div class="tree-item empty" *ngIf="recordingCameras().length === 0"
            style="padding: 10px; color: var(--muted); font-size: 13px;">
            No hay c√°maras con grabaci√≥n NAS activada.
          </div>
        </ul>
      </ul>
    </div>

    <div style="flex:1"></div>

    <div class="drive-storage">
      <div class="storage-text">Almacenamiento Cloud NAS</div>
      <div class="storage-bar">
        <div class="storage-fill" [style.width.%]="cloudPct()"></div>
      </div>
      <div class="storage-meta">{{ totalSizeMb() | number:'1.0-1' }} MB en uso actual</div>
    </div>
  </div>

  <!-- DRIVE MAIN CONTENT -->
  <div class="drive-main">

    <!-- Topbar Breadcrumbs & Search -->
    <div class="drive-topbar">
      <div class="breadcrumbs">
        <a routerLink="/cameras" class="crumb-link">Mi Unidad VMS</a>
        <span class="crumb-sep">‚Ä∫</span>
        <span class="crumb-link">{{ cameraName() }}</span>
        <span class="crumb-sep">‚Ä∫</span>
        <span class="crumb-current">{{ selectedDate() || 'Seleccione una fecha' }}</span>
      </div>

      <div class="drive-actions">
        <div class="drive-search-box">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            class="search-icon">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input type="text" class="drive-search" placeholder="Buscar en carpeta..." [ngModel]="searchRec()"
            (ngModelChange)="searchRec.set($event)">
        </div>
        <button class="btn-icon-drive" (click)="loadCloudRecordings(selectedDate())" title="Actualizar">üîÑ</button>
      </div>
    </div>

    <!-- Loading / Empty States -->
    <div class="drive-empty" *ngIf="loadingRecordings()">
      <div class="spinner"></div>
      <p>Cargando directorio de grabaciones...</p>
    </div>

    <div class="drive-empty" *ngIf="!loadingRecordings() && filteredRecordings().length === 0">
      <div class="empty-folder-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
      </div>
      <h3>Carpeta Vac√≠a</h3>
      <p>Esta ruta NAS no contiene archivos MP4 grabados.</p>
    </div>

    <!-- Drive Files View (Grid Header) -->
    <div class="drive-grid-header" *ngIf="!loadingRecordings() && filteredRecordings().length > 0">
      <span>Nombre del archivo</span>
      <span>Tama√±o</span>
      <span>Modificado</span>
    </div>

    <!-- Drive Files Grid -->
    <div class="drive-files-container" *ngIf="!loadingRecordings() && filteredRecordings().length > 0">

      <div class="drive-file-row" *ngFor="let file of filteredRecordings()" (click)="playCloudVideo(file.path)">
        <div class="file-name-col">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"
            class="file-icon">
            <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
            <line x1="7" y1="2" x2="7" y2="22"></line>
            <line x1="17" y1="2" x2="17" y2="22"></line>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <line x1="2" y1="7" x2="7" y2="7"></line>
            <line x1="2" y1="17" x2="7" y2="17"></line>
            <line x1="17" y1="17" x2="22" y2="17"></line>
            <line x1="17" y1="7" x2="22" y2="7"></line>
          </svg>
          <span class="f-name">{{ file.filename || file.name }}</span>
        </div>
        <div class="file-size-col text-muted">{{ file.sizeMb | number:'1.1-1' }} MB</div>
        <div class="file-date-col text-muted">{{ file.startTime | date:'HH:mm:ss' }}</div>

        <div class="file-actions-hover">
          <button class="hover-btn" (click)="playCloudVideo(file.path); $event.stopPropagation()"
            title="Reproducir">‚ñ∂</button>
          <a class="hover-btn dl" [href]="getDownloadUrl(file.path)" target="_blank" (click)="$event.stopPropagation()"
            title="Descargar">‚¨á</a>
        </div>
      </div>

    </div>

  </div> <!-- /drive-main -->

</div>

<!-- VIDEO PLAYER OVERLAY MODAL -->
<div class="rec-player-overlay" *ngIf="currentVideoSource()">
  <div class="rec-player-wrap">
    <div class="rec-player-header">
      <div class="now-playing-label">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polygon points="10 8 16 12 10 16 10 8"></polygon>
        </svg>
        Reproduciendo Video NVR
      </div>
      <button class="close-btn" (click)="currentVideoSource.set(null)">‚úï Cerrar</button>
    </div>
    <video #videoPlayer controls autoplay class="rec-player-video"></video>
  </div>
</div>